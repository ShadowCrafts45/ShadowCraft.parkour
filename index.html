<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shadow-craft — Parkour Edition</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    html,body{margin:0;height:100%;background:#111;overflow:hidden;font-family:sans-serif}
    canvas{display:block}
    #hud{position:fixed;left:12px;top:12px;z-index:60;background:rgba(0,0,0,.45);color:#fff;padding:10px 12px;border-radius:8px;font-family:monospace;font-size:13px}
    #start-screen{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(-45deg,#0f0f0f,#1a1a1a,#222,#0f0f0f);background-size:400% 400%;animation:gradientShift 12s ease infinite;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;color:#fff;font-family:'Segoe UI',sans-serif;text-align:center}
    @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    #game-title{font-size:48px;color:#ffd36b;text-shadow:0 0 12px rgba(255,211,107,.4);animation:floatTitle 4s ease-in-out infinite}
    @keyframes floatTitle{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
    #load-world-button{padding:10px 18px;font-size:16px;background:#ffd36b;color:#000;border:none;border-radius:10px;box-shadow:0 0 12px rgba(255,211,107,.4);cursor:pointer;font-weight:700;transition:transform .3s ease,box-shadow .3s ease}
    #load-world-button:hover{transform:scale(1.08);box-shadow:0 0 20px rgba(255,211,107,.6)}
    #controls-ui{position:fixed;left:0;right:0;bottom:0;display:none;justify-content:space-between;padding:12px;z-index:45}
    #joy-left{width:140px;height:140px;margin-left:12px;position:relative}
    .joy-bg{width:100%;height:100%;background:rgba(255,255,255,.04);border-radius:50%;border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center}
    .joy-knob{width:48px;height:48px;background:rgba(255,255,255,.14);border-radius:50%;transform:translate(-50%,-50%);position:absolute;left:50%;top:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px}
    #right-controls{margin-right:12px;display:flex;flex-direction:column;gap:10px;align-items:flex-end}
    .btn{width:56px;height:56px;background:rgba(255,255,255,.06);border-radius:12px;border:1px solid rgba(255,255,255,.12);color:#fff;font-size:20px;display:flex;align-items:center;justify-content:center;user-select:none}
  </style>
</head>
<body>
  <div id="start-screen">
    <h1 id="game-title">Shadow-craft: Parkour Edition</h1>
    <button id="load-world-button">▶️ Start Parkour</button>
  </div>
  <div id="hud">Loading...</div>
  <div id="controls-ui">
    <div id="joy-left">
      <div class="joy-bg"></div>
      <div class="joy-knob" id="joy-knob">•</div>
    </div>
    <div id="right-controls">
      <div id="look-area" style="width: 50vw; height: 100vh;"></div>
      <div id="button-stack">
        <div class="btn" id="btn-jump">⏫</div>
      </div>
    </div>
  </div>
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.module.js';

const inputState={jump:!1,moveX:0,moveZ:0},joystick={active:!1,id:null,startX:0,startY:0,dx:0,dy:0};
const isMobile=/Mobi|Android|iPhone|iPad|iPod|Tablet/i.test(navigator.userAgent);
const hud=document.getElementById('hud'),jumpBtn=document.getElementById('btn-jump'),controlsUI=document.getElementById('controls-ui');
if(isMobile)controlsUI.style.display='flex';
let startTime=null,lastCheckpoint=null;
const P_H=1.8,P_W=0.3; 
const W_W=100,W_H=36,W_D=100;
const B_A=0;
const BLOCKS={2:{name:'Stone',color:0x6e6e6e},3:{name:'Grass',color:0x2e8b57},4:{name:'Wood',color:0x7b4a2b},5:{name:'Leaves',color:0x3e803e},6:{name:'Sand',color:0xd2b48c},9:{name:'Gold',color:0xffc300}};
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const idx=(x,y,z)=>x+W_W*(z+W_D*y);

class VoxelWorld{
  constructor(w,h,d,s){
    this.w=w;this.h=h;this.d=d;
    this.b=new Uint8Array(w*h*d);
    this.g=new THREE.Group();
    s.add(this.g);
    this.gen();
    this.upd();
  }
  inB(x,y,z){return x>=0&&y>=0&&z>=0&&x<this.w&&y<this.h&&z<this.d}
  get(x,y,z){if(!this.inB(x,y,z))return B_A;return this.b[idx(x,y,z)]}
  set(x,y,z,v){if(!this.inB(x,y,z))return;this.b[idx(x,y,z)]=v}
  gen(){
    for(let x=0;x<this.w;x++){
      for(let z=0;z<this.d;z++){
        const r=Math.sin(x*.08)*Math.cos(z*.06);
        let h=Math.floor(1+3*(.5+.5*r)+Math.random()*1);
        const e=Math.min(x,z,this.w-1-x,this.d-1-z);
        if(e<3)h=Math.max(1,1+Math.floor(Math.random()*1.2));
        for(let y=0;y<h;y++){
          if(e<3)this.set(x,y,z,6);
          else if(y<h-1)this.set(x,y,z,2);
          else this.set(x,y,z,3);
        }
        if(h>2&&Math.random()<.15&&e>=5){
          const t=2+Math.floor(Math.random()*2);
          for(let ty=h;ty<h+t&&ty<this.h-1;ty++)this.set(x,ty,z,4);
          const ly=Math.min(h+t,this.h-2);
          for(let ix=-1;ix<=1;ix++)for(let iz=-1;iz<=1;iz++)for(let iy=0;iy<=1;iy++){
            const lx=x+ix,lz=z+iz,lyp=ly+iy;
            if(this.inB(lx,lyp,lz)&&this.get(lx,lyp,lz)===B_A)this.set(lx,lyp,lz,5);
          }
        }
      }
    }
    for(let x=48;x<=52;x++)for(let z=48;z<=52;z++)this.set(x,10,z,2);
    for(let i=0;i<5;i++){
      const x=Math.floor(20+Math.random()*(this.w-40));
      const z=Math.floor(20+Math.random()*(this.d-40));
      const y=Math.floor(12+Math.random()*20);
      this.set(x,y,z,9);
    }
  }
  upd(){
    while(this.g.children.length){
      const c=this.g.children.pop();
      c.geometry?.dispose?.();c.material?.dispose?.();
    }
    const g=new THREE.BoxGeometry(1,1,1);
    const m=new THREE.Matrix4(),l={};
    for(let x=0;x<this.w;x++)for(let y=0;y<this.h;y++)for(let z=0;z<this.d;z++){
      const i=this.get(x,y,z);
      if(i&&i!==B_A)(l[i]=l[i]||[]).push({x,y,z});
    }
    Object.keys(l).forEach(k=>{
      const id=parseInt(k),a=l[k];
      const mat=new THREE.MeshLambertMaterial({color:BLOCKS[id].color});
      const inst=new THREE.InstancedMesh(g,mat,a.length);
      for(let i=0;i<a.length;i++){
        m.makeTranslation(a[i].x+.5,a[i].y+.5,a[i].z+.5);
        inst.setMatrixAt(i,m);
      }
      this.g.add(inst);
    });
  }
}

const scene=new THREE.Scene();
scene.background=new THREE.Color(0x111111);
const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3);
const renderer=new THREE.WebGLRenderer({antialias:!0});
renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);
const light=new THREE.DirectionalLight(0xffffff,1);
light.position.set(1,5,3);
scene.add(light);
scene.add(new THREE.AmbientLight(0xffffff,.5));
const world=new VoxelWorld(W_W,W_H,W_D,scene);
const player={pos:new THREE.Vector3(50.5,12,50.5),vel:new THREE.Vector3(),yaw:0,pitch:0};

// Controls setup
jumpBtn.addEventListener('touchstart',()=>inputState.jump=!0);
jumpBtn.addEventListener('touchend',()=>inputState.jump=!1);
const joy=document.getElementById('joy-left'),knob=document.getElementById('joy-knob');
joy.addEventListener('touchstart',e=>{
  const t=e.changedTouches[0];
  joystick.active=!0;joystick.id=t.identifier;joystick.startX=t.clientX;joystick.startY=t.clientY;
},{passive:!1});
joy.addEventListener('touchmove',e=>{
  for(const t of e.changedTouches){
    if(t.identifier===joystick.id){
      joystick.dx=t.clientX-joystick.startX;joystick.dy=t.clientY-joystick.startY;
      const max=40;
      const dx=clamp(joystick.dx,-max,max),dy=clamp(joystick.dy,-max,max);
      knob.style.transform=`translate(${dx}px,${dy}px)`;
      inputState.moveX=dx/max;inputState.moveZ=dy/max;
    }
  }
},{passive:!1});
joy.addEventListener('touchend',e=>{
  for(const t of e.changedTouches){
    if(t.identifier===joystick.id){
      joystick.active=!1;joystick.dx=joystick.dy=0;
      inputState.moveX=inputState.moveZ=0;knob.style.transform='translate(-50%,-50%)';
    }
  }
},{passive:!1});

const lookArea=document.getElementById('look-area');let lastTouch=null;
lookArea.addEventListener('touchstart',e=>{lastTouch=e.touches[0];},{passive:!1});
lookArea.addEventListener('touchmove',e=>{
  const t=e.touches[0];
  const dx=t.clientX-lastTouch.clientX,dy=t.clientY-lastTouch.clientY;
  player.yaw-=dx*.005;player.pitch-=dy*.005;
  player.pitch=clamp(player.pitch,-Math.PI/2+.01,Math.PI/2-.01);lastTouch=t;
},{passive:!1});

if(!isMobile){
  document.addEventListener('keydown',e=>{
    if(e.code==='Space')inputState.jump=!0;
    if(e.code==='KeyW')inputState.moveZ=1;
    if(e.code==='KeyS')inputState.moveZ=-1;
    if(e.code==='KeyA')inputState.moveX=-1;
    if(e.code==='KeyD')inputState.moveX=1;
  });
  document.addEventListener('keyup',e=>{
    if(e.code==='Space')inputState.jump=!1;
    if(e.code==='KeyW'||e.code==='KeyS')inputState.moveZ=0;
    if(e.code==='KeyA'||e.code==='KeyD')inputState.moveX=0;
  });
  document.addEventListener('click',()=>document.body.requestPointerLock?.());
  function onMouseMove(e){
    if(document.pointerLockElement===document.body){
      player.yaw-=e.movementX*.0025;player.pitch-=e.movementY*.0025;
      player.pitch=clamp(player.pitch,-Math.PI/2+.01,Math.PI/2-.01);
    }
  }
  document.addEventListener('pointerlockchange',()=>{
    if(document.pointerLockElement===document.body)window.addEventListener('mousemove',onMouseMove);
    else window.removeEventListener('mousemove',onMouseMove);
  });
}

function tick(){
  requestAnimationFrame(tick);
  if(!startTime)startTime=performance.now();
  const elapsed=((performance.now()-startTime)/1000).toFixed(1);
  hud.innerText=`Parkour Mode\nTime: ${elapsed}s`;

  // Physics Vars
  const s=.07,f=.8,rA=player.yaw;
  const forward=new THREE.Vector3(Math.sin(rA),0,Math.cos(rA));
  const right=new THREE.Vector3().crossVectors(forward,new THREE.Vector3(0,1,0));
  let onGround=!1;

  // 1. Horizontal Velocity
  if(inputState.moveX!==0||inputState.moveZ!==0){
    const hF=new THREE.Vector3();
    hF.addScaledVector(forward,-inputState.moveZ*s);
    hF.addScaledVector(right,inputState.moveX*s);
    player.vel.x=hF.x;player.vel.z=hF.z;
  }else{
    player.vel.x*=f;player.vel.z*=f;
  }

  // 2. Gravity
  player.vel.y-=.008;
  player.vel.y=Math.max(player.vel.y,-.3);

  // --- A. Y-AXIS COLLISION ---
  let sY=player.vel.y;
  let nFY=player.pos.y-P_H+sY;
  if(sY<0){ 
    const fBY=Math.floor(nFY);
    if(world.get(Math.floor(player.pos.x),fBY,Math.floor(player.pos.z))!==B_A){
      player.pos.y=fBY+1.0+P_H; 
      player.vel.y=0;onGround=!0;sY=0;
    }
  }else if(sY>0){
    if(world.get(Math.floor(player.pos.x),Math.floor(player.pos.y+sY),Math.floor(player.pos.z))!==B_A){
      player.vel.y=0;sY=0;
    }
  }
  player.pos.y+=sY;
  if(inputState.jump&&onGround){
    player.vel.y=.25;
    if(!isMobile)inputState.jump=!1;
  }
  
  // --- B. X/Z-AXIS COLLISION ---
  const fYC=Math.floor(player.pos.y-P_H+.01),hYC=Math.floor(player.pos.y-.2);
  let nBX=Math.floor(player.pos.x+player.vel.x+Math.sign(player.vel.x)*P_W);
  if(world.get(nBX,fYC,Math.floor(player.pos.z))!==B_A||world.get(nBX,hYC,Math.floor(player.pos.z))!==B_A)player.vel.x=0;
  
  let nBZ=Math.floor(player.pos.z+player.vel.z+Math.sign(player.vel.z)*P_W);
  if(world.get(Math.floor(player.pos.x),fYC,nBZ)!==B_A||world.get(Math.floor(player.pos.x),hYC,nBZ)!==B_A)player.vel.z=0;

  player.pos.x+=player.vel.x;
  player.pos.z+=player.vel.z;
  
  // Respawn/Checkpoint
  if(player.pos.y<-10){
    player.pos.set(50.5,12,50.5);player.vel.set(0,0,0);
  }
  const cx=Math.floor(player.pos.x),cy=Math.floor(player.pos.y-P_H),cz=Math.floor(player.pos.z);
  if(world.get(cx,cy,cz)===9&&lastCheckpoint!==`${cx},${cy},${cz}`){
    lastCheckpoint=`${cx},${cy},${cz}`;
    hud.innerText+='\n✅ Checkpoint reached!';
  }

  // Camera Update
  const dir=new THREE.Vector3(
    Math.sin(player.yaw)*Math.cos(player.pitch),
    Math.sin(player.pitch),
    Math.cos(player.yaw)*Math.cos(player.pitch)
  );
  camera.position.copy(player.pos).add(new THREE.Vector3(0,P_H-.2,0)); 
  camera.lookAt(player.pos.clone().add(new THREE.Vector3(0,P_H-.2,0).add(dir.multiplyScalar(5))));
  renderer.render(scene,camera);
}

document.getElementById('load-world-button').addEventListener('click', () => {
  document.getElementById('start-screen').style.display = 'none';
  player.pos.set(50.5,12,50.5);player.vel.set(0,0,0);player.yaw=0;player.pitch=0;
  camera.position.set(player.pos.x,player.pos.y+P_H-.2,player.pos.z);
  camera.lookAt(player.pos.x,player.pos.y+P_H-.2,player.pos.z+1);
  tick();
});
</script>
</body>
</html>
